<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stocks & Requisitions Dashboard</title>

    <style>
      body {
        font-family: Roboto, Arial, sans-serif;
        margin: 12px;
        background: #f7f8fb;
      }
      .container {
        max-width: 1300px;
        margin: auto;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      .small {
        font-size: 12px;
        color: #666;
      }
      .header-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .header-right button {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        background: #666;
        color: white;
      }
      .header-right button:hover {
        background: #555;
      }

      .badge {
        padding: 6px 12px;
        border-radius: 18px;
        font-weight: 600;
        color: #fff;
      }
      .badge-office {
        background: #1976d2;
      }
      .badge-special {
        background: #6a1b9a;
      }
      .badge-zero {
        background: #2e7d32;
      }

      .card {
        background: #fff;
        padding: 18px;
        border-radius: 14px;
        margin-bottom: 16px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #eee;
      }
      th {
        background: #f1f1f1;
        position: sticky;
        top: 0;
      }

      .card-scroll {
        max-height: 380px;
        overflow: auto;
      }

      .action-btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        margin-right: 4px;
      }
      .action-edit {
        background: #ffc107;
      }
      .action-delete {
        background: #dc3545;
        color: #fff;
      }
      .action-approve {
        background: #28a745;
        color: #fff;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
      .loading::after {
        content: " ⏳";
      }

      /* MODAL */
      #officeModal,
      #specialModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
      }
      #officeModal .box,
      #specialModal .box {
        background: #fff;
        margin: 4% auto;
        padding: 20px;
        width: 92%;
        max-width: 950px;
        border-radius: 14px;
        max-height: 80vh;
        overflow-y: auto;
      }
    </style>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
  </head>

  <body>
    <div class="container">
      <header>
        <div>
          <h1>Stocks & Requisitions Dashboard V2</h1>
          <div class="small">Live from Spreadsheet</div>
        </div>
        <div class="header-right">
          <span id="officeBadge" class="badge">Office</span>
          <span id="specialBadge" class="badge">Special</span>
        </div>
      </header>

      <!-- ================= PIE + INVENTORY ================= -->
      <div class="card">
        <div id="statusPie" style="height: 320px"></div>
      </div>

      <div class="card">
        <h3>OFFICE STOCKS – Inventory</h3>
        <div class="card-scroll">
          <table>
            <thead>
              <tr>
                <th>Item ID</th>
                <th>Description</th>
                <th>Unit</th>
                <th style="text-align: right">Stocks</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ================= SPECIAL REQUEST ================= -->
      <div class="card">
        <h3>Pending – Special Request</h3>
        <table>
          <thead>
            <tr>
              <th>Branch</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="specialBody"></tbody>
        </table>
      </div>

      <!-- ================= OFFICE SUPPLIES ================= -->
      <div class="card">
        <h3>Pending – Office Supplies</h3>
        <table>
          <thead>
            <tr>
              <th>Branch</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="officeBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ================= OFFICE SUPPLIES MODAL ================= -->
    <div id="officeModal">
      <div class="box">
        <h3 id="officeModalTitle"></h3>

        <div style="margin-bottom: 10px">
          <button
            class="action-btn action-approve"
            onclick="batchApprove(this, 'office')"
          >
            Batch Approve
          </button>
          <button class="print-btn action-print" onclick="batchPrint(this, 'office')">
            Batch Print PDF
          </button>
          <button
            class="action-btn"
            onclick="officesuppliesreceivedEmail(this, 'office')"
          >
            Office Supplies Received Email
          </button>
          <button class="action-btn" onclick="claimedEmail(this, 'office')">
            Claimed Email
          </button>
          <button style="float: right" onclick="closeModal('office')">Close</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Qty</th>
              <th>Unit</th>
              <th>Description</th>
              <th>Uprice</th>
              <th>Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="officeModalBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ================= SPECIAL REQUEST MODAL ================= -->
    <div id="specialModal">
      <div class="box">
        <h3 id="specialModalTitle"></h3>

        <div style="margin-bottom: 10px">
          <button
            class="action-btn action-approve"
            onclick="batchApprove(this, 'special')"
          >
            Batch Approve
          </button>
          <button class="print-btn action-print" onclick="batchPrint(this, 'special')">
            Batch Print PDF
          </button>
          <button class="action-btn" onclick="specialrequestEmail(this, 'special')">
            Special Request Email
          </button>
          <button style="float: right" onclick="closeModal('special')">Close</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Qty</th>
              <th>Unit</th>
              <th>Description</th>
              <th>Uprice</th>
              <th>Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="specialModalBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(init);

      let currentRows = [];
      let branchGroupsCache = []; // Cache for branch groups to avoid JSON.stringify issues

      // Branch -> email mapping (integrated per provided list)
      const branchEmailMap = {
        ADMIN: "gmpcpurchasing@gmail.com",
        WAREHOUSE: "warehousegiant21@gmail.com",
        LAGTANG: "giantmotoprolagtang@gmail.com",
        "V-RAMA": "gmpcguad_accounting@yahoo.com.ph",
        BULACAO: "ivyhamistoso@gmail.com",
        "Y3S TALISAY": "gmpcyamaha3st@gmail.com",
        MINGLANILLA: "giantmotoprolinao@gmail.com",
        "Y3S PARDO": "gmpcy3spardo@yahoo.com",
        "LAPU-LAPU": "giantmotoproopon19@gmail.com",
        BACAYAN: "gmpcbacayan@gmail.com",
        "SAN FERNANDO MB": "gmpcsanfernando@gmail.com",
        "Y3S SAN FERNANDO": "sanfernandoyamaha3s@gmail.com",
        LILOAN: "gmpctayud@gmail.com",
        "CORDOVA MB": "gmpccordova@gmail.com",
        "Y3S CORDOVA": "gmpccordovay3s@gmail.com",
        CLARIN: "gmpcclarin@gmail.com",
        TOLEDO: "giantmotopro_corporation@yahoo.com.ph",
        UBAY: "gmpcubay@gmail.com",
        CARMEN: "gmpccarmenbh@gmail.com",
        TUBIGON: "gmpctubigon@gmail.com",
        TALIBON: "gmpctalibon@gmail.com",
        BOGO: "gmpcbogo@gmail.com",
        BALAMBAN: "gmpcbalamban@gmail.com",
        "Y3S BARILI": "yamaha3sbarili@gmail.com",
        "BARILI MB": "giantmotoprobarilibranch@gmail.com",
        "SIERRA BULLONES": "gmpcsierra@gmail.com",
        PITOGO: "gmpcpitogo@gmail.com",
        "TAYUD CONSOLACION": "gmpctayudconsolacion@gmail.com",
        PINAMUNGAJAN: "gmpcpinamungajan22@gmail.com",
        CANDIJAY: "giantcandijay@gmail.com",
        "YATI LILOAN": "gmpcyatililoan@gmail.com",
      };

      function getEmailForBranch(branch) {
        if (!branch) return branchEmailMap["ADMIN"];
        const up = branch.toUpperCase().trim();
        if (branchEmailMap[branch]) return branchEmailMap[branch];
        if (branchEmailMap[up]) return branchEmailMap[up];
        const foundKey = Object.keys(branchEmailMap).find(
          (k) => k.toLowerCase().trim() === branch.toLowerCase().trim(),
        );
        if (foundKey) return branchEmailMap[foundKey];
        return branchEmailMap["ADMIN"];
      }

      function formatNumberWithThousands(num) {
        return parseFloat(num).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function init() {
        refreshAll();
        setInterval(refreshAll, 10000);
      }

      function refreshAll() {
        google.script.run
          .withSuccessHandler(renderGrouped)
          .getPendingGroupedByBranch();
        google.script.run
          .withSuccessHandler(updateBadges)
          .getPendingBreakdown();
        google.script.run
          .withSuccessHandler(renderDashboard)
          .getDashboardData();
      }

      function updateBadges(d) {
        officeBadge.textContent = `Office: ${d.office}`;
        specialBadge.textContent = `Special: ${d.special}`;
        officeBadge.className =
          "badge " + (d.office ? "badge-office" : "badge-zero");
        specialBadge.className =
          "badge " + (d.special ? "badge-special" : "badge-zero");
      }

      function renderDashboard(d) {
        drawPie(d.statusCounts);
        inventoryBody.innerHTML = "";
        d.addStocks.forEach((r) => {
          inventoryBody.innerHTML += `
      <tr>
        <td>${r.itemId}</td>
        <td>${r.description}</td>
        <td>${r.unit}</td>
        <td style="text-align:right">${r.totalRunningStocks}</td>
        <td>${r.status}</td>
      </tr>`;
        });
      }

      function drawPie(sc) {
        const rows = [["Status", "Count"]];
        Object.keys(sc || {}).forEach((k) => rows.push([k, sc[k]]));
        if (rows.length === 1) rows.push(["None", 0]);
        new google.visualization.PieChart(statusPie).draw(
          google.visualization.arrayToDataTable(rows),
          { title: "Request Status Distribution", pieHole: 0.35 },
        );
      }

      function renderGrouped(data) {
        renderBranchTable("officeBody", data.office);
        renderBranchTable("specialBody", data.special);
      }

      function renderBranchTable(id, groups) {
        const b = document.getElementById(id);
        b.innerHTML = "";
        (groups || []).forEach((g) => {
          const cacheIndex = branchGroupsCache.length;
          branchGroupsCache.push(g);
          b.innerHTML += `
      <tr>
        <td>${g.branch}</td>
        <td>${g.total}</td>
        <td>
          <button class="action-btn action-edit"
            onclick='openModalFromCache(${cacheIndex})'>View</button>
        </td>
      </tr>`;
        });
      }

      function openModalFromCache(cacheIndex) {
        if (cacheIndex >= 0 && cacheIndex < branchGroupsCache.length) {
          openModal(branchGroupsCache[cacheIndex]);
        }
      }

      /* MODAL */
      function openModal(g) {
        // Determine request type from first row
        const requestType = g.rows.length > 0 
          ? (g.rows[0].sheetName.toLowerCase().includes("special") ? "special" : "office")
          : "office";
        
        currentRows = g.rows;
        
        const modalId = requestType === "special" ? "specialModal" : "officeModal";
        const titleId = requestType === "special" ? "specialModalTitle" : "officeModalTitle";
        const bodyId = requestType === "special" ? "specialModalBody" : "officeModalBody";
        
        document.getElementById(titleId).textContent = `Branch: ${g.branch}`;
        document.getElementById(bodyId).innerHTML = "";
        
        let total = 0;
        g.rows.forEach((r) => {
          total += r.amount || 0;
          document.getElementById(bodyId).innerHTML += `
      <tr>
        <td>${r.qty}</td>
        <td>${r.unit}</td>
        <td>${r.description}</td>
        <td>${formatNumberWithThousands(r.uprice || 0)}</td>
        <td>${formatNumberWithThousands(r.amount || 0)}</td>
        <td>
          <button class="action-btn action-edit"
            onclick="editQty('${r.sheetName}',${r.rowNumber},${r.qty})">Edit</button>
          <button class="action-btn action-approve"
            onclick="approveRow(this,'${r.sheetName}',${r.rowNumber})">Approve</button>
          <button class="action-btn action-delete"
            onclick="deleteRow(this,'${r.sheetName}',${r.rowNumber})">Delete</button>
        </td>
      </tr>`;
        });
        
        document.getElementById(modalId).style.display = "block";
      }
      
      function closeModal(type) {
        if (type === "special") {
          document.getElementById("specialModal").style.display = "none";
        } else if (type === "office") {
          document.getElementById("officeModal").style.display = "none";
        } else {
          // Close both for backward compatibility
          document.getElementById("officeModal").style.display = "none";
          document.getElementById("specialModal").style.display = "none";
        }
      }

      /* ACTIONS */
      function editQty(s, r, q) {
        const n = prompt("Edit Qty:", q);
        if (n != null)
          google.script.run
            .withSuccessHandler(refreshAll)
            .editPendingRow(s, r, { Qty: n });
      }
      function approveRow(btn, s, r) {
        btn.classList.add("loading");
        google.script.run
          .withSuccessHandler(refreshAll)
          .approvePendingRow(s, r);
      }
      function deleteRow(btn, s, r) {
        if (!confirm("Delete?")) return;
        btn.classList.add("loading");
        google.script.run.withSuccessHandler(refreshAll).deletePendingRow(s, r);
      }

      /* BATCH */
      function batchApprove(btn, type) {
        btn.classList.add("loading");
        google.script.run
          .withSuccessHandler(() => {
            btn.classList.remove("loading");
            refreshAll();
          })
          .batchApprove(currentRows);
      }

      function batchPrint(btn, type) {
        google.script.run
          .withSuccessHandler((selectedPerBranch) => {
            if (
              !selectedPerBranch ||
              Object.keys(selectedPerBranch).length === 0
            ) {
              alert(
                "No PDFs found. Please ensure PDF URLs are populated in the spreadsheet.",
              );
              return;
            }

            let pdfCount = 0;
            Object.keys(selectedPerBranch).forEach((branch) => {
              const pdf = selectedPerBranch[branch];
              if (pdf && pdf.url) {
                window.open(pdf.url, "_blank");
                pdfCount++;
              }
            });

            alert(
              `Opened ${pdfCount} PDF(s) — one per branch (prefer Special requests/ Office Supplies).`,
            );
          })
          .getBatchPdfUrls(currentRows);
      }

      function officesuppliesreceivedEmail(btn, type) {
        if (!currentRows || currentRows.length === 0) {
          alert("No items selected to email.");
          return;
        }

        // Get branch name from modal title
        const titleElement = type === "office" ? document.getElementById("officeModalTitle") : document.getElementById("officeModalTitle");
        const branch = titleElement.textContent.replace(/^Branch:\s*/, "").trim();

        // Resolve email addresses
        const to = getEmailForBranch(branch);

        // Email subject
        const subject = `OFFICE SUPPLIES RECEIVED – ${branch}`;

        // Build email body
        let body = `Good Day Ma'am/Sir,\n\n`;
        body += `We have received your office supplies request.\n\n`;
        body += `${"=".repeat(100)}\n\n`;
        body += `Request Details:\n\n`;
        body += `# - Description - Qty - Unit\n`;
        body += `${"=".repeat(100)}\n`;

        currentRows.forEach((r, index) => {
          body += `${index + 1} - ${r.description} - ${r.qty} - ${r.unit}\n`;
        });

        body += `${"=".repeat(100)}\n\n`;
        body += `Thank you, God bless!\n`;

        // Gmail compose URL
        const gmailUrl =
          "https://mail.google.com/mail/?view=cm&fs=1" +
          `&to=${encodeURIComponent(to)}` +
          `&su=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        // Open Gmail compose in new tab
        window.open(gmailUrl, "_blank");
      }

      function claimedEmail(btn, type) {
        if (!currentRows || currentRows.length === 0) {
          alert("No items selected.");
          return;
        }

        btn.classList.add("loading");

        // Get branch name from modal title
        const titleElement = document.getElementById("officeModalTitle");
        const branch = titleElement.textContent.replace(/^Branch:\s*/, "").trim();

        // Resolve email addresses
        const to = getEmailForBranch(branch);

        // Email subject
        const subject = `OFFICE SUPPLIES READY FOR PICKUP – ${branch}`;

        // Build email body
        let body = `Good Day Ma'am/Sir,\n\n`;
        body += `The requested office supplies are ready for pickup.\n\n`;
        body += `${"=".repeat(100)}\n\n`;
        body += `Request Details:\n\n`;
        body += `# - Description - Qty - Unit\n`;
        body += `${"=".repeat(100)}\n`;

        currentRows.forEach((r, index) => {
          body += `${index + 1} - ${r.description} - ${r.qty} - ${r.unit}\n`;
        });

        body += `${"=".repeat(100)}\n\n`;
        body += `Thank you, God bless!\n`;

        // Gmail compose URL
        const gmailUrl =
          "https://mail.google.com/mail/?view=cm&fs=1" +
          `&to=${encodeURIComponent(to)}` +
          `&su=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        // Open Gmail compose in new tab
        window.open(gmailUrl, "_blank");

        btn.classList.remove("loading");
      }

      function specialrequestEmail(btn, type) {
        if (!currentRows || currentRows.length === 0) {
          alert("No items selected.");
          return;
        }

        btn.classList.add("loading");

        // Get branch name from modal title
        const titleElement = document.getElementById("specialModalTitle");
        const branch = titleElement.textContent.replace(/^Branch:\s*/, "").trim();

        // Resolve email addresses
        const to = getEmailForBranch(branch);

        // Email subject
        const subject = `SPECIAL REQUEST RECEIVED – ${branch}`;

        // Build email body
        let body = `Good Day Ma'am/Sir,\n\n`;
        body += `We have received your special request.\n\n`;

        //
        body += `NOTE: Please be informed that this request has been approved by our corporate accountant and has been endorsed to the disbursement officer for issuance.\n\n`;
        body += `${"=".repeat(100)}\n\n`;
        body += `Special Request Details:\n\n`;
        body += `# - Qty - Unit - Description - Uprice - Amount\n`;
        body += `${"=".repeat(100)}\n`;

        let totalAmount = 0;
        currentRows.forEach((r, index) => {
          const amount = r.amount || 0;
          totalAmount += amount;
          const uprice = formatNumberWithThousands(r.uprice || 0);
          const amountFormatted = formatNumberWithThousands(amount);
          body += `${index + 1} - ${r.qty} - ${r.unit} - ${r.description} - ${uprice} - ${amountFormatted}\n`;
        });

        body += `${"=".repeat(100)}\n`;
        body += `TOTAL AMOUNT: ${formatNumberWithThousands(totalAmount)}\n\n`;
        body += `Thank you, God bless!\n`;

        // Gmail compose URL
        const gmailUrl =
          "https://mail.google.com/mail/?view=cm&fs=1" +
          `&to=${encodeURIComponent(to)}` +
          `&su=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        // Open Gmail compose in new tab
        window.open(gmailUrl, "_blank");

        btn.classList.remove("loading");
      }
    </script>
  </body>
</html>
